"use strict";(self.webpackChunkshield=self.webpackChunkshield||[]).push([[887],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>h});var r=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var l=r.createContext({}),c=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},d=function(e){var n=c(e.components);return r.createElement(l.Provider,{value:n},e.children)},p="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},x=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=c(t),x=a,h=p["".concat(l,".").concat(x)]||p[x]||u[x]||o;return t?r.createElement(h,i(i({ref:n},d),{},{components:t})):r.createElement(h,i({ref:n},d))}));function h(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,i=new Array(o);i[0]=x;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s[p]="string"==typeof e?e:a,i[1]=s;for(var c=2;c<o;c++)i[c]=t[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,t)}x.displayName="MDXCreateElement"},1917:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var r=t(7462),a=(t(7294),t(3905));const o={},i="Shield as a proxy",s={unversionedId:"tour/shield-as-proxy",id:"tour/shield-as-proxy",title:"Shield as a proxy",description:"Untill now, we were using Shield's admin APIs. Those were responsible for managing Shield's entities. Next, we are use Shield as a proxy.",source:"@site/docs/tour/shield-as-proxy.md",sourceDirName:"tour",slug:"/tour/shield-as-proxy",permalink:"/shield/tour/shield-as-proxy",draft:!1,editUrl:"https://github.com/goto/shield/edit/master/docs/docs/tour/shield-as-proxy.md",tags:[],version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Checking permissions in SpiceDB",permalink:"/shield/tour/check-permissions"},next:{title:"Overview",permalink:"/shield/guides/overview"}},l={},c=[{value:"Resource Table",id:"resource-table",level:3},{value:"Relations Table",id:"relations-table",level:3}],d={toc:c};function p(e){let{components:n,...t}=e;return(0,a.kt)("wrapper",(0,r.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"shield-as-a-proxy"},"Shield as a proxy"),(0,a.kt)("p",null,"Untill now, we were using Shield's admin APIs. Those were responsible for managing Shield's entities. Next, we are use Shield as a proxy."),(0,a.kt)("p",null,"We had attached the backend service ",(0,a.kt)("inlineCode",{parentName:"p"},"entropy")," to Shield earlier, and now we are going to create a ",(0,a.kt)("inlineCode",{parentName:"p"},"firehose")," resource in it.\nBefore, going ahead have a look at the configuration file below. Detailed explaining on this configuration file would be in resources/concepts."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},'rules:\n  - backends:\n      - name: entropy\n        target: "http://entropy.io"\n        prefix: "/api"\n        frontends:\n          - name: list_firehoses\n            path: "/api/firehoses"\n            method: "GET"\n          - name: list_firehoses\n            path: "/api/firehoses/{firehose_id}"\n            method: "GET"\n          - name: create_firehose\n            path: "/api/firehoses"\n            method: "POST"\n            hooks:\n              - name: authz\n                config:\n                  action: authz_action\n                  attributes:\n                    resource:\n                      key: firehose.name\n                      type: json_payload\n                    project:\n                      key: X-Shield-Project\n                      type: header\n                      source: request\n                    organization:\n                      key: X-Shield-Org\n                      type: header\n                      source: request\n                    resource_type:\n                      value: "firehose"\n                      type: constant\n                    group_attribute:\n                      key: X-Shield-Group\n                      type: header\n                      source: request\n                  relations:\n                    - role: owner\n                      subject_principal: group\n                      subject_id_attribute: group_attribute\n')),(0,a.kt)("p",null,"Let's make the following request."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},'curl --location --request POST \'http://localhost:5556/api/firehoses\'\n--header \'Content-Type: application/json\'\n--header \'X-Shield-Email: admin@gotocompany.com\'\n--header \'X-Shield-Org: 4eb3c3b4-962b-4b45-b55b-4c07d3810ca8\'\n--header \'X-Shield-Project: 1b89026b-6713-4327-9d7e-ed03345da288\'\n--header \'X-Shield-Group: 86e2f95d-92c7-4c59-8fed-b7686cccbf4f\'\n--data-raw \'{\n    "created_by": "Shield Org Admin",\n    "configuration": {\n        "SOURCE_KAFKA_CONSUMER_CONFIG_AUTO_COMMIT_ENABLE": false,\n        "SOURCE_KAFKA_CONSUMER_CONFIG_FETCH_MIN_BYTES": "1",\n        "SOURCE_KAFKA_CONSUMER_CONFIG_MANUAL_COMMIT_MIN_INTERVAL_MS": "-1",\n        "SOURCE_KAFKA_CONSUMER_CONFIG_AUTO_OFFSET_RESET": "latest",\n        "SINK_TYPE": "log",\n        "FILTER_ENGINE": "no_op",\n        "RETRY_MAX_ATTEMPTS": "2147483647",\n        "LOG_LEVEL": "INFO",\n        "INPUT_SCHEMA_PROTO_CLASS": "xxxxx",\n        "SOURCE_KAFKA_TOPIC": "delete-me-abcdef",\n        "SCHEMA_REGISTRY_STENCIL_URLS": "xxxxx",\n        "SOURCE_KAFKA_CONSUMER_CONFIG_MAX_POLL_RECORDS": "1000"\n    },\n    "replicas": 2,\n    "title": "test-firehose-creation-xxxxx",\n    "group_id": "5ea18244-8e7a-xxxx-xxxx-ddf4b3fe3698",\n    "team": "data_engineering",\n    "cluster": "g-xxxxx",\n    "stream_name": "g-xxxxx",\n    "description": "Creating this firehose for testing purpose.",\n    "projectID": "g-xxxxx",\n    "orgID": "26ab9a89-de8d-xxxx-xxxx-5ba3f84be7b2",\n    "entity": "xxxxx"\n}\'\n')),(0,a.kt)("p",null,"Now this request will produce a series of events."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"It will hit Shield(proxy) at ",(0,a.kt)("inlineCode",{parentName:"li"},"/api/firehoses")," path, since there are no middleware the request shall be forwarded to the backend.\nWe expect that a resource will be created in ",(0,a.kt)("inlineCode",{parentName:"li"},"entropy")," and we'll get a response."),(0,a.kt)("li",{parentName:"ul"},"Now, hooks will be engaged. We only have a single ",(0,a.kt)("inlineCode",{parentName:"li"},"authz")," hook, which creates a resource inside Shield. It will use resource name, org, project and type from either of request, response or as a constant, to create a resource."),(0,a.kt)("li",{parentName:"ul"},"By deafult, no relation is created for this resource, but we can confire this. Here, we have configured to add the group with ",(0,a.kt)("inlineCode",{parentName:"li"},"owner")," role.")),(0,a.kt)("p",null,"We'll get a firehose object sent by ",(0,a.kt)("inlineCode",{parentName:"p"},"entropy")," as a response, though we don't have interest in that."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'201\n{\n    "firehose": {\n        "replicas": 2,\n        "created_by": "Shield Org Admin",\n        "title": "test-firehose-creation-xxxxx",\n        "group_id": "5ea18244-8e7a-xxxx-xxxx-ddf4b3fe3698",\n        "team": "data_engineering",\n        "stream_name": "g-xxxxx",\n        "description": "Creating this firehose for testing purpose.",\n        "projectID": "g-xxxxx",\n        "entity": "xxxxx",\n        "environment": "integration",\n        "name": "g-xxxxx-firehose-creation-xxxxx-firehose",\n        "configuration": {\n            "xxxxx": "xxxxx"\n        },\n        "state": "running",\n        "stop_date": null,\n        "status": {\n            "xxxxx": "xxxxx"\n        },\n        "pods": ["xxxxx"]\n    }\n}\n')),(0,a.kt)("p",null,"What we have interest in is going to the resource and relations tables and checking for the entries."),(0,a.kt)("h3",{id:"resource-table"},"Resource Table"),(0,a.kt)("p",null,"It got an entry for the resource we just created."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"                                       urn                                       |                             name                             |              project_id              |                org_id                |   namespace_id   |          created_at           |          updated_at           | deleted_at |               user_id                |                  id                  \n---------------------------------------------------------------------------------+--------------------------------------------------------------+--------------------------------------+--------------------------------------+------------------+-------------------------------+-------------------------------+------------+--------------------------------------+--------------------------------------\n r/entropy/firehose/g-xxxxx-firehose-creation-xxxxx-firehose | g-xxxxx-firehose-creation-xxxxx-firehose | 1b89026b-6713-4327-9d7e-ed03345da288 | 4eb3c3b4-962b-4b45-b55b-4c07d3810ca8 | entropy/firehose | 2022-12-08 13:25:37.335962+00 | 2022-12-08 13:25:37.335962+00 |            | 2fd7f306-61db-4198-9623-6f5f1809df11 | 28105b9a-1717-47cf-a5d9-49249b6638df\n(1 row)\n")),(0,a.kt)("h3",{id:"relations-table"},"Relations Table"),(0,a.kt)("p",null,"It got an entry for the role ",(0,a.kt)("inlineCode",{parentName:"p"},"entropy/firehose:owner")," for the group ",(0,a.kt)("inlineCode",{parentName:"p"},"86e2f95d-92c7-4c59-8fed-b7686cccbf4f"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"                  id                  | subject_namespace_id |              subject_id              | object_namespace_id |              object_id               |        role_id         |          created_at           |          updated_at           | deleted_at \n--------------------------------------+----------------------+--------------------------------------+---------------------+--------------------------------------+------------------------+-------------------------------+-------------------------------+------------\n 460c44a6-f074-4abe-8f8e-949e7a3f5ec2 | user                 | 2fd7f306-61db-4198-9623-6f5f1809df11 | organization        | 4eb3c3b4-962b-4b45-b55b-4c07d3810ca8 | organization:owner     | 2022-12-07 14:10:42.881572+00 | 2022-12-07 14:10:42.881572+00 | \n 10797ec9-6744-4064-8408-c0919e71fbca | organization         | 4eb3c3b4-962b-4b45-b55b-4c07d3810ca8 | project             | 1b89026b-6713-4327-9d7e-ed03345da288 | project:organization   | 2022-12-07 14:31:46.517828+00 | 2022-12-07 14:31:46.517828+00 | \n 29b82d6e-b6fd-4009-9727-1e619c802e23 | organization         | 4eb3c3b4-962b-4b45-b55b-4c07d3810ca8 | group               | 86e2f95d-92c7-4c59-8fed-b7686cccbf4f | group:organization     | 2022-12-07 17:03:59.537254+00 | 2022-12-07 17:03:59.537254+00 | \n 0cec1f0a-68ef-4a70-aabd-f3dd1e0eacac | group                | 86e2f95d-92c7-4c59-8fed-b7686cccbf4f | entropy/firehose    | 28105b9a-1717-47cf-a5d9-49249b6638df | entropy/firehose:owner | 2022-12-08 13:25:37.550927+00 | 2022-12-08 13:25:37.550927+00 | \n(4 rows)\n")))}p.isMDXComponent=!0}}]);